<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>图片在线压缩</title>
<script src="https://atusu.cn/imgys/jszip.min.js"></script>
<script src="https://atusu.cn/imgys/FileSaver.min.js"></script>
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --accent:#2563eb; --muted:#6b7280; --ok:#16a34a;
  --radius:12px;
}
html,body{height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; background:var(--bg); color:#0f172a;}
.wrap{max-width:1100px; margin:28px auto; padding:20px;}
.panel{background:var(--card); padding:20px; border-radius:var(--radius); box-shadow:0 6px 24px rgba(12,15,25,0.06);}
h1{margin:0 0 10px; font-size:20px;}
.controls{display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:14px 0;}
select,input[type="number"], input[type="range"]{padding:8px 10px; border-radius:8px;margin-left:5px; border:1px solid #e6edf3; background:#fff;}
label.inline{display:inline-flex; gap:8px;     margin-right: 10px;align-items:center; color:var(--muted); font-size:14px;}
.drop{border:2px dashed #e2e8f0; padding:40px; border-radius:12px; text-align:center; cursor:pointer; color:var(--muted); background:#fbfdff;}
.drop.drag{border-color:var(--accent); background:#f0f7ff;}
.buttons{display:flex; gap:10px;}
button{border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;}
.btn-primary{background:var(--accent); color:#fff;margin-right:5px; }
.btn-ghost{background:#4CAF50; color:#ffffff;}
.btn-disabled{background:#e6e9ee; color:#9aa3b2; cursor:not-allowed;}
.grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px; margin-top:18px;}
.card{background:#fff; border-radius:12px; padding:12px; box-shadow:0 4px 18px rgba(12,15,25,0.04); display:flex; flex-direction:column; gap:8px;}
.thumb{width:100%; height:160px; object-fit:contain; border-radius:8px; background:#fafafa; border:1px solid #f1f5f9;margin-top: 5px;
    margin-bottom: 5px;}
.meta{display:flex; justify-content:space-between; align-items:center; gap:8px; font-size:13px; color:var(--muted);}
.meta .name{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.progress{height:8px; background:#f1f5f9; border-radius:6px; overflow:hidden;}
.bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent), #60a5fa); transition:width .35s ease;}
.status{font-size:13px; color:var(--muted);}
.status.ok{color:var(--ok); font-weight:600;}
.actions{display:flex; gap:8px; margin-top:6px;}
.small-btn{padding:6px 8px; border-radius:8px; font-weight:600; cursor:pointer; border:1px solid #e6edf3; background:#fff;}
.small-btn:disabled{opacity:0.6; cursor:not-allowed;}
.info-row{display:flex; justify-content:space-between; align-items:center; gap:8px; font-size:13px; color:var(--muted);}
footer{margin-top:12px; font-size:12px; color:var(--muted);}
@media (max-width:640px){ .controls{flex-direction:column; align-items:stretch;} .meta{flex-direction:column; align-items:flex-start;} }
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>图片在线压缩</h1>
    <div id="drop" class="drop">点击或将图片拖放到此处（支持多选）<input id="fileInput" type="file" accept="image/*,.svg,.heic" multiple style="display:none"></div>

    <div class="controls">
      <label class="inline">输出格式
        <select id="outFormat">
          <option value="same">保持原格式</option>
          <option value="image/jpeg">JPEG (.jpg)</option>
          <option value="image/webp">WebP (.webp)</option>
          <option value="image/png">PNG (.png)</option>
        </select>
      </label>
<label class="inline">质量
  <input id="quality" type="range" min="0.1" max="1" step="0.05" value="0.8" style="width:140px;">
  <span id="qualityText"
        style="min-width:10px;text-align:right;font-size:13px;color:var(--muted);margin-right:10px;">
    80%
  </span>
</label>
      <label class="inline">最大宽度
        <input id="maxWidth" type="number" value="1600" min="0" style="width:100px;">
      </label>

      <div class="buttons" style="margin-left:auto">
        <button id="compressAll" class="btn-primary">开始压缩</button>
        <button id="downloadAll" class="btn-ghost btn-disabled" disabled>下载全部 ZIP</button>
      </div>
    </div>

    <div class="info-row" style="margin-bottom:10px">
      <div id="summary">当前：0 个文件</div>
      <div id="globalStatus"></div>
    </div>
    <footer>提示：所有处理在本地浏览器进行，文件不会上传到服务器。</footer>
    <div id="grid" class="grid"></div>
  </div>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const drop = document.getElementById('drop');
const grid = document.getElementById('grid');
const outFormat = document.getElementById('outFormat');
const qualityEl = document.getElementById('quality');
const maxWidthEl = document.getElementById('maxWidth');
const compressAllBtn = document.getElementById('compressAll');
const downloadAllBtn = document.getElementById('downloadAll');
const summary = document.getElementById('summary');
const globalStatus = document.getElementById('globalStatus');

let items = [];

drop.addEventListener('click', ()=> fileInput.click());
['dragenter','dragover'].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.add('drag');}));
['dragleave','drop'].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.remove('drag');}));
drop.addEventListener('drop', ev=>{ev.preventDefault(); handleFiles(ev.dataTransfer.files);});
fileInput.addEventListener('change', ()=> handleFiles(fileInput.files));

function handleFiles(fileList){
  items = [];
  const arr = Array.from(fileList);
  for(const f of arr){
    const allowed = (f.type.startsWith('image/') && !f.type.includes('gif')) || f.name.toLowerCase().endsWith('.svg') || f.name.toLowerCase().endsWith('.heic');
    if(!allowed) continue;
    const id = cryptoRandomId();
    const origFormat = f.name.split('.').pop().toUpperCase();
    items.push({ id, file:f, origSize:f.size, origFormat, resultBlob:null, resultName:null, status:'待处理', progress:0, format:'' });
  }
  renderGrid();
}

function renderGrid(){
  grid.innerHTML = '';
  summary.textContent = `当前：${items.length} 个文件`;
  items.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.id = 'card-'+it.id;
    card.innerHTML = `
      <div class="meta">
        <div class="name" title="${it.file.name}">${it.file.name}</div>
        <div style="text-align:right">原格式：${it.origFormat} / ${formatBytes(it.origSize)}</div>
      </div>
      <img class="thumb" id="thumb-${it.id}" alt="${it.file.name}">
      <div class="info-row">
        <div style="flex:1">
          <div class="progress"><div id="bar-${it.id}" class="bar"></div></div>
          <div style="display:flex; justify-content:space-between; margin-top:6px;">
            <div class="status" id="status-${it.id}">状态：${it.status}</div>
            <div style="font-size:13px; color:var(--muted)" id="size-${it.id}">压缩后：—</div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="small-btn" id="downloadOrig-${it.id}">下载原图</button>
        <button class="small-btn" id="downloadMin-${it.id}" disabled>下载压缩</button>
        <button class="small-btn" id="remove-${it.id}">移除</button>
      </div>
    `;
    grid.appendChild(card);

    const thumb = document.getElementById('thumb-'+it.id);
    const url = URL.createObjectURL(it.file);
    thumb.src = url;
    thumb.onload = ()=> URL.revokeObjectURL(url);

    document.getElementById('downloadOrig-'+it.id).onclick = ()=> saveFile(it.file, it.file.name);
    document.getElementById('downloadMin-'+it.id).onclick = ()=> { if(it.resultBlob) saveFile(it.resultBlob, it.resultName || it.file.name); };
    document.getElementById('remove-'+it.id).onclick = ()=> { items = items.filter(x=>x.id!==it.id); renderGrid(); };
  });
}

compressAllBtn.addEventListener('click', async ()=>{
  if(items.length===0) return alert('请先选择图片');
  compressAllBtn.disabled = true;
  compressAllBtn.textContent = '正在压缩请稍等...';
  globalStatus.textContent = '';

  for(let i=0;i<items.length;i++){
    const it = items[i];
    globalStatus.textContent = `正在处理：${it.file.name} (${i+1}/${items.length})`;
    try{ await processItem(it); }catch(e){ console.error('处理失败', e); it.status='错误'; updateCard(it); }
    updateCard(it);
  }

  compressAllBtn.disabled = false;
  compressAllBtn.textContent = '开始压缩';
  globalStatus.textContent = '全部处理完成，再次点击选择框自动清除压缩结果';
});

async function processItem(it){
  it.status='处理中';
  updateCard(it);

  const format = outFormat.value;
  const q = parseFloat(qualityEl.value || qualityEl.defaultValue || 0.8);
  const maxW = parseInt(maxWidthEl.value || 0);

  if(it.file.name.toLowerCase().endsWith('.svg') || it.file.type==='image/svg+xml'){
    const text = await it.file.text();
    const min = text.replace(/<!--[\s\S]*?-->/g,'').replace(/\n+/g,' ').replace(/>\s+</g,'><').trim();
    it.resultBlob = new Blob([min], {type:'image/svg+xml'});
    it.resultName = it.file.name;
    it.format='SVG';
    it.status='完成';
    it.progress=100;
    it.compressedSize=it.resultBlob.size;
    updateCard(it);
    return;
  }

  const img = await readImage(it.file);
  const { canvas } = resizeCanvas(img, maxW);
  await smoothProgress(it, 20);
  await smoothProgress(it, 70);

  let mime = (format==='same' || !format) ? it.file.type || 'image/jpeg' : format;
  const blob = await canvasToBlobAsync(canvas, mime, q);
  it.resultBlob = blob;
  it.resultName = it.file.name.replace(/\.[^.]+$/,'') + '.' + mime.split('/').pop();
  it.compressedSize = blob.size;
  it.status='完成';
  it.progress=100;
  it.format = mime.split('/').pop().toUpperCase();
  updateCard(it);
}

function updateCard(it){
  const bar = document.getElementById('bar-'+it.id);
  const statusEl = document.getElementById('status-'+it.id);
  const sizeEl = document.getElementById('size-'+it.id);
  const downloadMinBtn = document.getElementById('downloadMin-'+it.id);

  if(bar) bar.style.width = (it.progress||0)+'%';
  if(statusEl){ 
    statusEl.textContent = `状态：${it.status}`;
    statusEl.className='status'+((it.status.indexOf('完成')!==-1)?' ok':''); 
  }

  if(sizeEl){
    if(it.compressedSize){
      sizeEl.textContent = `压缩后：${formatBytes(it.compressedSize)} (${it.format || ''})`;
    } else {
      sizeEl.textContent = '压缩后：—';
    }
  }

  if(downloadMinBtn) downloadMinBtn.disabled = !it.resultBlob;

  summary.textContent = `当前：${items.length} 个文件，已压缩 ${items.filter(x=>x.resultBlob).length} 个`;

  if(items.every(x=>x.resultBlob)){
    downloadAllBtn.disabled=false;
    downloadAllBtn.classList.remove('btn-disabled');
    downloadAllBtn.classList.add('btn-ghost');
    downloadAllBtn.onclick=downloadAllZip;
  } else {
    downloadAllBtn.disabled=true;
    downloadAllBtn.classList.add('btn-disabled');
    downloadAllBtn.classList.remove('btn-ghost');
  }
}

/* ======= 工具函数 ======= */
function readImage(file){ 
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>{
      const img=new Image();
      img.onload=()=>res(img);
      img.onerror=rej;
      img.src=e.target.result;
    };
    r.onerror=rej;
    r.readAsDataURL(file);
  }); 
}
function resizeCanvas(img,maxW){ 
  let w=img.width,h=img.height;
  if(maxW>0 && w>maxW){ const scale=maxW/w; w=Math.round(w*scale); h=Math.round(h*scale); }
  const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0,w,h);
  return {canvas,ctx};
}
function canvasToBlobAsync(canvas,mime,quality){ 
  return new Promise((res,rej)=>{
    if(mime.includes('jpeg')){
      const c2=document.createElement('canvas'); c2.width=canvas.width; c2.height=canvas.height;
      const ctx=c2.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c2.width,c2.height); ctx.drawImage(canvas,0,0);
      c2.toBlob(b=>b?res(b):rej(new Error('toBlob failed')),mime,quality);
    } else {
      canvas.toBlob(b=>b?res(b):rej(new Error('toBlob failed')),mime,quality);
    }
  });
}
function smoothProgress(item,target){ 
  return new Promise(res=>{
    const step=()=>{
      if(item.progress>=target){ res(); return; }
      item.progress=Math.min(item.progress+Math.random()*12+6,target);
      updateCard(item);
      setTimeout(step,90+Math.random()*80);
    };
    step();
  });
}
async function downloadAllZip(){ 
  const zip=new JSZip();
  const folder=zip.folder('images');
  const toZip=items.filter(i=>i.resultBlob);
  if(toZip.length===0) return alert('没有可打包的压缩文件');
  globalStatus.textContent=`打包 ${toZip.length} 个文件...`;
  toZip.forEach(i=>folder.file(i.resultName||i.file.name,i.resultBlob));
  const blob=await zip.generateAsync({type:'blob'},meta=>{ globalStatus.textContent=`打包中：${Math.round(meta.percent)}%`; });
  saveFile(blob,'compressed_images.zip');
  globalStatus.textContent='打包完成';
}
function saveFile(blobOrFile,filename){ 
  try{ saveAs(blobOrFile,filename); }catch(e){ 
    const url=URL.createObjectURL(blobOrFile); const a=document.createElement('a'); a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1500); 
  } 
}
function formatBytes(bytes){ 
  if(bytes===0) return '0 B'; const k=1024,dm=2,s=['B','KB','MB','GB','TB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return parseFloat((bytes/k**i).toFixed(dm))+' '+s[i]; 
}
function cryptoRandomId(){ return Math.random().toString(36).substr(2,9)+Date.now().toString(36); }


const qualityText = document.getElementById('qualityText');

function updateQualityText(){
  const q = parseFloat(qualityEl.value || 0);
  qualityText.textContent = Math.round(q * 100) + '%';
}

// 初始化显示
updateQualityText();

// 拖动时实时更新
qualityEl.addEventListener('input', updateQualityText);
</script>
</body>
</html>
